<!doctype html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>CF Pages æ§åˆ¶å°</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Apple System Colors */
      --accent-blue: #007AFF;
      --danger-color: #FF3B30;
      --success-color: #34C759;
      
      /* Light Mode Variables */
      --bg-base: #F5F7FA;
      --glass-sidebar: rgba(255, 255, 255, 0.75); /* ç¨å¾®å¢åŠ ä¸é€æ˜åº¦ä»¥é€‚åº”æ¸…æ™°èƒŒæ™¯ */
      --glass-content: rgba(255, 255, 255, 0.90);
      --glass-border: rgba(255, 255, 255, 0.5);
      --text-primary: #1d1d1f;
      --text-secondary: #86868b;
      --input-bg: rgba(255, 255, 255, 0.6);
      --input-border: rgba(0, 0, 0, 0.1);
      --overlay-color: rgba(255, 255, 255, 0); /* å»é™¤é®ç½©é¢œè‰²ï¼ŒèƒŒæ™¯æ›´é€äº® */
      
      --shadow-window: 0 24px 60px rgba(0, 0, 0, 0.15); /* åŠ æ·±é˜´å½±ä»¥åŒºåˆ†æ¸…æ™°èƒŒæ™¯ */
      --shadow-card: 0 6px 16px rgba(0, 0, 0, 0.04);
      --radius-window: 24px;
      --radius-element: 14px;
    }

    [data-theme="dark"] {
      /* Dark Mode Variables */
      --bg-base: #000000;
      --glass-sidebar: rgba(30, 30, 30, 0.75);
      --glass-content: rgba(20, 20, 20, 0.85);
      --glass-border: rgba(255, 255, 255, 0.1);
      --text-primary: #F5F5F7;
      --text-secondary: #98989d;
      --input-bg: rgba(255, 255, 255, 0.15);
      --input-border: transparent;
      --overlay-color: rgba(0, 0, 0, 0.2); /* æ·±è‰²æ¨¡å¼ä¿ç•™è½»å¾®é®ç½© */
      
      --accent-blue: #0A84FF;
      --shadow-window: 0 40px 80px rgba(0, 0, 0, 0.6);
    }

    * { box-sizing: border-box; transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1); }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--bg-base);
      color: var(--text-primary);
      overflow: hidden;
      position: relative;
    }

    /* === è‡ªå®šä¹‰èƒŒæ™¯å±‚ === */
    #custom-bg-layer {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: -3;
      object-fit: cover;
      opacity: 0; /* JSæ§åˆ¶æ·¡å…¥ */
      transition: opacity 1.5s ease;
    }

    /* é»˜è®¤èƒŒæ™¯ (æ— è‡ªå®šä¹‰æ—¶æ˜¾ç¤º) */
    #default-bg-gradient {
      position: fixed;
      top: -50%; left: -50%; width: 200%; height: 200%;
      background: radial-gradient(circle at center, rgba(0,122,255,0.08) 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, rgba(52,199,89,0.05) 0%, transparent 40%);
      z-index: -2;
      animation: breathe 15s ease-in-out infinite alternate;
      pointer-events: none;
    }

    /* æ™ºèƒ½é®ç½© (å·²ç§»é™¤æ¨¡ç³Šï¼Œä»…ä¿ç•™ææ·¡çš„é¢œè‰²è°ƒèŠ‚) */
    #bg-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: var(--overlay-color);
      /* backdrop-filter: blur(20px);  <-- å·²ç§»é™¤æ­¤è¡Œï¼ŒèƒŒæ™¯ä¸å†æ¨¡ç³Š */
      z-index: -1;
      pointer-events: none;
    }

    @keyframes breathe { from { transform: scale(1) rotate(0deg); } to { transform: scale(1.1) rotate(5deg); } }

    /* === ä¸»çª—å£ === */
    .app-window {
      width: 92%;
      max-width: 1100px;
      height: 85vh;
      max-height: 850px;
      display: flex;
      /* çª—å£æœ¬èº«ä¿æŒç£¨ç ‚ç»ç’ƒæ•ˆæœï¼Œä»¥ä¾¿çœ‹æ¸…æ–‡å­— */
      background: var(--glass-sidebar);
      backdrop-filter: blur(50px) saturate(180%);
      -webkit-backdrop-filter: blur(50px) saturate(180%);
      border-radius: var(--radius-window);
      box-shadow: var(--shadow-window);
      border: 1px solid var(--glass-border);
      position: relative;
      z-index: 10;
      flex-direction: row;
      opacity: 0;
      transform: scale(0.96) translateY(10px);
      animation: openApp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    @keyframes openApp {
      to { opacity: 1; transform: scale(1) translateY(0); }
    }

    /* ä¾§è¾¹æ  */
    .sidebar {
      width: 300px;
      border-right: 1px solid var(--glass-border);
      padding: 32px 24px;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      background: rgba(255,255,255,0.05);
    }

    .brand-area {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 32px;
    }
    .brand-icon {
      width: 44px; height: 44px;
      border-radius: 12px;
      object-fit: cover;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .brand-text { font-weight: 600; font-size: 17px; }

    .scroll-container { flex: 1; overflow-y: auto; padding-right: 4px; }
    .scroll-container::-webkit-scrollbar { width: 4px; }
    .scroll-container::-webkit-scrollbar-thumb { background: rgba(128,128,128,0.2); border-radius: 4px; }

    .form-group { margin-bottom: 20px; }
    label {
      display: block; font-size: 12px; font-weight: 500;
      color: var(--text-secondary); margin-bottom: 8px; padding-left: 2px;
    }

    input, select {
      width: 100%; padding: 12px 14px; font-size: 13px;
      border-radius: var(--radius-element);
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-primary);
      outline: none; font-family: inherit;
    }
    input:focus, select:focus {
      background: var(--input-bg);
      box-shadow: 0 0 0 2px var(--accent-blue);
      border-color: transparent;
    }
    input::placeholder { color: var(--text-secondary); opacity: 0.5; }

    /* æŒ‰é’® */
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 10px 18px; border-radius: 50px;
      font-size: 13px; font-weight: 500; cursor: pointer;
      border: none; transition: all 0.2s; white-space: nowrap;
    }
    .btn:active { transform: scale(0.96); }
    
    .btn.primary {
      background: var(--accent-blue); color: white;
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.25);
    }
    .btn.primary:hover { filter: brightness(1.08); }
    
    .btn.secondary {
      background: rgba(128,128,128,0.1); color: var(--accent-blue);
    }
    .btn.secondary:hover { background: rgba(128,128,128,0.15); }

    .btn.danger {
      background: rgba(255, 59, 48, 0.1); color: var(--danger-color);
    }
    .btn.danger:hover { background: var(--danger-color); color: white; }

    /* åº•éƒ¨ */
    .sidebar-footer {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--glass-border);
      display: flex; justify-content: space-between; align-items: center;
    }
    .theme-toggle {
      width: 36px; height: 36px; border-radius: 50%; border: none;
      background: rgba(128,128,128,0.1); color: var(--text-primary);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
    }

    /* å³ä¾§å†…å®¹ */
    .content-area {
      flex: 1;
      background: var(--glass-content);
      padding: 40px 50px;
      overflow-y: auto;
      display: flex; flex-direction: column;
    }

    .header-bar {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;
    }
    .header-bar h2 { font-size: 26px; font-weight: 600; margin: 0; }

    .list-card {
      background: var(--input-bg);
      border-radius: 18px;
      padding: 8px;
      min-height: 200px;
      margin-bottom: 30px;
      border: 1px solid var(--input-border);
      box-shadow: var(--shadow-card);
      overflow-y: auto;
    }

    .list-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 20px; margin-bottom: 4px;
      border-radius: 12px; transition: background 0.2s;
    }
    .list-item:hover { background: rgba(128,128,128,0.08); }

    .status-badge {
      font-size: 11px; padding: 4px 10px; border-radius: 10px;
      font-weight: 600; margin-left: 12px; display: flex; align-items: center; gap: 6px;
    }
    .status-badge::before { content:''; display:block; width:6px; height:6px; border-radius:50%; }
    .badge-active { background: rgba(52,199,89,0.1); color: var(--success-color); }
    .badge-active::before { background: var(--success-color); }
    .badge-pending { background: rgba(255,159,10,0.1); color: #FF9F0A; }
    .badge-pending::before { background: #FF9F0A; }

    .grid-actions {
      display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px;
    }
    .action-panel {
      padding: 20px;
      background: var(--input-bg);
      border-radius: 18px;
      border: 1px solid var(--input-border);
    }

    .log-box {
      background: rgba(0,0,0,0.03);
      color: var(--text-secondary);
      padding: 20px; border-radius: 14px;
      font-family: 'Menlo', monospace; font-size: 12px; line-height: 1.6;
      height: 120px; overflow-y: auto;
      border: 1px solid var(--input-border);
    }
    [data-theme="dark"] .log-box { background: rgba(255,255,255,0.05); }

    /* ç™»å½•å±‚ */
    .login-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255, 255, 255, 0); /* ç™»å½•èƒŒæ™¯å®Œå…¨é€æ˜ï¼Œæ˜¾ç¤ºåº•å±‚å£çº¸ */
      backdrop-filter: blur(10px); /* ä»…ç™»å½•æ—¶ç¨å¾®æ¨¡ç³ŠèƒŒæ™¯ï¼Œèšç„¦æ³¨æ„åŠ› */
      z-index: 100; display: flex; align-items: center; justify-content: center;
    }
    [data-theme="dark"] .login-overlay { background: rgba(0, 0, 0, 0.2); }

    .login-card {
      width: 340px;
      background: var(--glass-content);
      padding: 40px; border-radius: 28px;
      box-shadow: 0 30px 60px rgba(0,0,0,0.15); text-align: center;
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(40px);
    }

    /* çµåŠ¨å²› Toast */
    .island-toast {
      position: fixed; top: 24px; left: 50%; transform: translateX(-50%) translateY(-150%);
      background: rgba(20,20,20,0.9); color: white;
      padding: 12px 24px; border-radius: 100px;
      display: flex; align-items: center; gap: 10px;
      font-size: 14px; font-weight: 500; z-index: 200;
      transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .island-toast.show { transform: translateX(-50%) translateY(0); }
    [data-theme="dark"] .island-toast { background: rgba(240,240,240,0.95); color: black; }

    @media (max-width: 800px) {
      .app-window { flex-direction: column; width: 100%; height: 100%; border-radius: 0; border: none; }
      .sidebar { width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--glass-border); }
      .content-area { padding: 24px; }
      .grid-actions { grid-template-columns: 1fr; }
    }
    .hidden { display: none !important; }
    .shake { animation: shake 0.4s; }
    @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)} }
  </style>
</head>
<body>

  <!-- èƒŒæ™¯å±‚ï¼šé»˜è®¤æ¸å˜ -->
  <div id="default-bg-gradient"></div>
  
  <!-- èƒŒæ™¯å±‚ï¼šJSåŠ¨æ€æ’å…¥çš„å›¾ç‰‡æˆ–è§†é¢‘å°†ä½äºæ­¤å¤„ï¼Œä¸”æ¸…æ™°æ— æ¨¡ç³Š -->
  
  <!-- èƒŒæ™¯å±‚ï¼šææ·¡é®ç½© (æ— æ¨¡ç³Š) -->
  <div id="bg-overlay"></div>

  <!-- Toast é€šçŸ¥ -->
  <div id="toast" class="island-toast">
    <span id="toastIcon"></span>
    <span id="toastMsg">Notification</span>
  </div>

  <!-- ç™»å½•ç•Œé¢ -->
  <div id="loginScreen" class="login-overlay">
    <div class="login-card">
      <img src="https://image.hyeri.us.kg/icon.png" style="width:80px; height:80px; border-radius:18px; margin-bottom:24px; box-shadow:0 8px 20px rgba(0,0,0,0.1);">
      <h3 style="margin:0 0 8px; font-weight:600;">éªŒè¯èº«ä»½</h3>
      <p style="color:var(--text-secondary); font-size:13px; margin:0 0 24px;">Cloudflare Pages ç©ºé—´ç«™</p>
      <input type="password" id="loginPassword" placeholder="è¾“å…¥è®¿é—®å¯†ç " style="text-align:center; margin-bottom:16px;">
      <button id="loginBtn" class="btn primary" style="width:100%; height:44px;">è¿›å…¥ç³»ç»Ÿ</button>
      <div id="errorMsg" style="color:var(--danger-color); font-size:12px; margin-top:16px; opacity:0;">å¯†ç é”™è¯¯</div>
    </div>
  </div>

  <!-- ä¸»ç•Œé¢ -->
  <div id="mainScreen" class="app-window hidden">
    
    <!-- ä¾§è¾¹æ ï¼šé…ç½®ä¸­å¿ƒ -->
    <div class="sidebar">
      <div class="brand-area">
        <img src="https://image.hyeri.us.kg/icon.png" class="brand-icon">
        <div class="brand-text">CF Cloud Console</div>
      </div>

      <div class="scroll-container">
        <div class="form-group">
          <label>è´¦æˆ· ID</label>
          <input id="accountId" placeholder="Cloudflare Account ID" />
        </div>
        <div class="form-group">
          <label>Pages API ä»¤ç‰Œ</label>
          <input id="pagesToken" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
        <div class="form-group">
          <label>Zone API ä»¤ç‰Œ</label>
          <input id="zoneToken" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
        
        <!-- è‡ªå®šä¹‰èƒŒæ™¯å…¥å£ -->
        <div class="form-group">
          <label style="color:var(--accent-blue);">è‡ªå®šä¹‰èƒŒæ™¯ (ç›´é“¾)</label>
          <input id="backgroundUrl" placeholder="å›¾ç‰‡æˆ–è§†é¢‘ URL (mp4/mov)" />
        </div>

        <div style="display:flex; gap:10px; margin-top:20px;">
          <button id="loadConfigBtn" class="btn secondary" style="flex:1;">è¯»å–</button>
          <button id="saveConfigBtn" class="btn primary" style="flex:1;">ä¿å­˜</button>
        </div>

        <div style="height:1px; background:var(--glass-border); margin:24px 0;"></div>

        <div class="form-group">
          <label>é¡¹ç›®åˆ—è¡¨</label>
          <select id="projectSelect" style="margin-bottom:10px;"><option value="">-- è¯·å…ˆåŠ è½½é¡¹ç›® --</option></select>
          <button id="loadProjectsBtn" class="btn secondary" style="width:100%;">è·å–é¡¹ç›®</button>
        </div>
      </div>

      <div class="sidebar-footer">
        <span style="font-size:12px; color:var(--text-secondary);">å·²è¿æ¥ Cloudflare</span>
        <button id="themeToggle" class="theme-toggle">â˜€</button>
      </div>
    </div>

    <!-- å†…å®¹åŒº -->
    <div class="content-area">
      <div class="header-bar">
        <h2>åŸŸåç®¡ç†</h2>
        <button id="refreshDomainsBtn" class="btn secondary">åˆ·æ–°åˆ—è¡¨</button>
      </div>

      <div id="domainList" class="list-card">
        <div style="display:flex; align-items:center; justify-content:center; height:100%; color:var(--text-secondary); flex-direction:column; gap:10px;">
          <span style="font-size:24px; opacity:0.3;">â˜ï¸</span>
          <span>æš‚æ— æ•°æ®</span>
        </div>
      </div>

      <div class="grid-actions">
        <div class="action-panel">
          <label style="color:var(--accent-blue);">æ·»åŠ åŸŸå (è‡ªåŠ¨ DNS)</label>
          <div style="display:flex; gap:10px; margin-top:10px;">
            <input id="addDomainInput" placeholder="sub.example.com" />
            <button id="addDomainBtn" class="btn primary">æ·»åŠ </button>
          </div>
        </div>
        <div class="action-panel">
          <label style="color:var(--danger-color);">ç§»é™¤åŸŸå</label>
          <div style="display:flex; gap:10px; margin-top:10px;">
            <input id="removeDomainInput" placeholder="è¾“å…¥åŸŸå" />
            <button id="removeDomainBtn" class="btn danger">åˆ é™¤</button>
          </div>
        </div>
      </div>

      <label>ç»ˆç«¯æ—¥å¿—</label>
      <div id="output" class="log-box">Ready...</div>
    </div>
  </div>

  <script>
    // --- èƒŒæ™¯å¤„ç†é€»è¾‘ ---
    const bgContainer = document.body;
    let currentBgEl = null;

    function applyBackground(url) {
      if (!url) {
        if(currentBgEl) { 
          currentBgEl.style.opacity = 0; 
          setTimeout(() => { if(currentBgEl) currentBgEl.remove(); currentBgEl = null; }, 1000); 
        }
        return;
      }

      const isVideo = /\.(mp4|webm|mov)(\?|$)/i.test(url);
      
      let newEl;
      if (isVideo) {
        newEl = document.createElement('video');
        newEl.src = url;
        newEl.autoplay = true;
        newEl.loop = true;
        newEl.muted = true;
        newEl.playsInline = true;
      } else {
        newEl = document.createElement('img');
        newEl.src = url;
      }

      newEl.id = 'custom-bg-layer';
      document.body.insertBefore(newEl, document.getElementById('bg-overlay'));
      requestAnimationFrame(() => { newEl.style.opacity = 1; });

      if (currentBgEl) {
        currentBgEl.style.opacity = 0;
        setTimeout(() => { if(currentBgEl) currentBgEl.remove(); }, 1500);
      }
      currentBgEl = newEl;
    }

    // --- UI äº¤äº’ ---
    const themeToggle = document.getElementById('themeToggle');
    const html = document.documentElement;
    const toast = document.getElementById('toast');
    const toastMsg = document.getElementById('toastMsg');
    const toastIcon = document.getElementById('toastIcon');
    let toastTimer;

    themeToggle.addEventListener('click', () => {
      const current = html.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', next);
      themeToggle.textContent = next === 'dark' ? 'ğŸŒ™' : 'â˜€';
    });

    function showToast(msg, type = 'info') {
      toastMsg.textContent = msg;
      if (type === 'success') toastIcon.textContent = 'âœ“';
      else if (type === 'error') toastIcon.textContent = '!';
      else toastIcon.textContent = 'â„¹';
      toast.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function triggerError() {
      const err = document.getElementById('errorMsg');
      const card = document.querySelector('.login-card');
      err.style.opacity = 1;
      card.classList.remove('shake');
      void card.offsetWidth;
      card.classList.add('shake');
    }

    // --- æ ¸å¿ƒé€»è¾‘ ---
    const loginScreen=document.getElementById('loginScreen');
    const mainScreen=document.getElementById('mainScreen');
    const loginPassword=document.getElementById('loginPassword');
    const loginBtn=document.getElementById('loginBtn');

    async function checkLogin(){
      const password=loginPassword.value.trim();
      if(!password) return triggerError();
      try{
        const resp=await fetch('/api/auth',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({password})
        });
        const data=await resp.json();
        if(data.success){
          sessionStorage.setItem('authenticated','true');
          showMainScreen();
        }else{ triggerError(); }
      }catch(e){ triggerError(); }
    }

    function showMainScreen(){
      loginScreen.style.opacity = 0;
      setTimeout(() => {
        loginScreen.classList.add('hidden');
        mainScreen.classList.remove('hidden');
        loadConfig();
      }, 300);
    }

    loginBtn.addEventListener('click',checkLogin);
    loginPassword.addEventListener('keypress',e=>{if(e.key==='Enter')checkLogin();});

    if(sessionStorage.getItem('authenticated')==='true'){
      loginScreen.classList.add('hidden');
      mainScreen.classList.remove('hidden');
      loadConfig();
    }

    const accountId=document.getElementById('accountId');
    const pagesToken=document.getElementById('pagesToken');
    const zoneToken=document.getElementById('zoneToken');
    const backgroundUrl=document.getElementById('backgroundUrl');
    const projectSelect=document.getElementById('projectSelect');
    const loadProjectsBtn=document.getElementById('loadProjectsBtn');
    const domainList=document.getElementById('domainList');
    const addDomainInput=document.getElementById('addDomainInput');
    const addDomainBtn=document.getElementById('addDomainBtn');
    const removeDomainInput=document.getElementById('removeDomainInput');
    const removeDomainBtn=document.getElementById('removeDomainBtn');
    const refreshDomainsBtn=document.getElementById('refreshDomainsBtn');
    const saveConfigBtn=document.getElementById('saveConfigBtn');
    const loadConfigBtn=document.getElementById('loadConfigBtn');
    const output=document.getElementById('output');

    async function apiCall(path,method='GET',body=null){
      output.innerHTML += `<div>> è¯·æ±‚: ${method} ${path}</div>`;
      output.scrollTop = output.scrollHeight;
      try{
        const resp=await fetch(path,{
          method,
          headers:{
            'Content-Type':'application/json',
            'X-Account-Id':accountId.value.trim(),
            'X-Pages-Token':pagesToken.value.trim(),
            'X-Zone-Token':zoneToken.value.trim()
          },
          body:body?JSON.stringify(body):null
        });
        const data=await resp.json().catch(()=>({error:'å“åº”é”™è¯¯'}));
        output.innerHTML += `<div style="color:${resp.ok?'#34C759':'#FF3B30'}">> çŠ¶æ€: ${data.success?'æˆåŠŸ':'å¤±è´¥'}</div>`;
        output.scrollTop = output.scrollHeight;
        return{ok:resp.ok,data};
      }catch(e){
        output.innerHTML += `<div style="color:#FF3B30">> é”™è¯¯: ${e.message}</div>`;
        return{ok:false,data:null};
      }
    }

    async function saveConfig(){
      const config={
        accountId:accountId.value.trim(),
        pagesToken:pagesToken.value.trim(),
        zoneToken:zoneToken.value.trim(),
        backgroundUrl:backgroundUrl.value.trim()
      };
      
      applyBackground(config.backgroundUrl);

      if(!config.accountId||!config.pagesToken||!config.zoneToken) return showToast('æ ¸å¿ƒé…ç½®ä¸å®Œæ•´', 'error');
      
      const res=await fetch('/api/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(config)});
      const data=await res.json();
      showToast(data.success?'é…ç½®å·²ä¿å­˜':'ä¿å­˜å¤±è´¥', data.success?'success':'error');
    }

    async function loadConfig(){
      const res=await fetch('/api/config');
      const data=await res.json();
      if(data.success&&data.config){
        accountId.value=data.config.accountId||'';
        pagesToken.value=data.config.pagesToken||'';
        zoneToken.value=data.config.zoneToken||'';
        backgroundUrl.value=data.config.backgroundUrl||'';
        
        if(data.config.backgroundUrl) {
          applyBackground(data.config.backgroundUrl);
        }

        output.innerHTML += `<div>> é…ç½®å·²ä»äº‘ç«¯åŠ è½½</div>`;
      }
    }

    async function loadProjects(){
      const acc=accountId.value.trim();
      if(!acc||!pagesToken.value.trim()) return showToast('é…ç½®ä¸å®Œæ•´', 'error');
      const res=await apiCall(`/api/accounts/${encodeURIComponent(acc)}/projects`);
      if(res.ok&&res.data.success){
        const projects=res.data.result||[];
        projectSelect.innerHTML=projects.map(p=>`<option value="${p.name}">${p.name}</option>`).join('');
        if(projects.length>0){
          projectSelect.value=projects[0].name;
          await loadDomains();
        }
        showToast('é¡¹ç›®å·²æ›´æ–°', 'success');
      }
    }

    async function loadDomains(){
      const acc=accountId.value.trim();
      const proj=projectSelect.value;
      if(!acc||!proj)return;
      const res=await apiCall(`/api/accounts/${encodeURIComponent(acc)}/projects/${encodeURIComponent(proj)}/domains`);
      domainList.innerHTML='';
      if(res.ok&&res.data.success){
        const domains=res.data.result||[];
        if(domains.length===0){
          domainList.innerHTML='<div style="display:flex;height:100%;align-items:center;justify-content:center;color:var(--text-secondary);">æš‚æ— åŸŸå</div>';
        }else{
          domains.forEach(d=>{
            const isAct = d.status==='active';
            const el=document.createElement('div');
            el.className='list-item';
            el.innerHTML=`
              <div style="display:flex;align-items:center;">
                <span style="font-weight:500">${d.name}</span>
                <span class="status-badge ${isAct?'badge-active':'badge-pending'}">${isAct?'å·²æ¿€æ´»':'éªŒè¯ä¸­'}</span>
              </div>
              <button class="btn secondary" style="padding:6px 14px; border-radius:14px; font-size:12px;" onclick="confirmAndRemove('${encodeURIComponent(d.name)}')">æ–­å¼€</button>
            `;
            domainList.appendChild(el);
          });
        }
      }
    }

    window.confirmAndRemove=async function(domainEncoded){
      const domain=decodeURIComponent(domainEncoded);
      if(!confirm(`ç§»é™¤åŸŸå ${domain}?`))return;
      const acc=accountId.value.trim();
      const proj=projectSelect.value;
      const res=await apiCall(`/api/accounts/${encodeURIComponent(acc)}/projects/${encodeURIComponent(proj)}/domains/${domain}`,'DELETE');
      if(res.ok&&res.data.success){
        await loadDomains();
        showToast('åˆ é™¤æˆåŠŸ', 'success');
      } else { showToast('åˆ é™¤å¤±è´¥', 'error'); }
    };

    addDomainBtn.addEventListener('click',async()=>{
      const acc=accountId.value.trim();
      const proj=projectSelect.value;
      const domain=addDomainInput.value.trim();
      if(!acc||!proj||!domain) return showToast('è¯·æ£€æŸ¥è¾“å…¥', 'error');
      const res=await apiCall(`/api/accounts/${encodeURIComponent(acc)}/projects/${encodeURIComponent(proj)}/domains`,'POST',{name:domain});
      if(res.ok&&res.data.success){
        addDomainInput.value='';
        await loadDomains();
        showToast(res.data.dns_created?'åŸŸååŠDNSå·²æ·»åŠ ':'åŸŸåå·²æ·»åŠ ', 'success');
      } else { showToast('æ·»åŠ å¤±è´¥', 'error'); }
    });

    removeDomainBtn.addEventListener('click',async()=>{
      const acc=accountId.value.trim();
      const proj=projectSelect.value;
      const domain=removeDomainInput.value.trim();
      if(!acc||!proj||!domain) return showToast('è¯·è¾“å…¥åŸŸå', 'error');
      const res=await apiCall(`/api/accounts/${encodeURIComponent(acc)}/projects/${encodeURIComponent(proj)}/domains/${domain}`,'DELETE');
      if(res.ok&&res.data.success){
        removeDomainInput.value='';
        await loadDomains();
        showToast('åˆ é™¤æˆåŠŸ', 'success');
      } else { showToast('åˆ é™¤å¤±è´¥', 'error'); }
    });

    refreshDomainsBtn.addEventListener('click',() => { loadDomains(); showToast('å·²åˆ·æ–°'); });
    loadProjectsBtn.addEventListener('click',loadProjects);
    projectSelect.addEventListener('change',loadDomains);
    saveConfigBtn.addEventListener('click',saveConfig);
    loadConfigBtn.addEventListener('click',loadConfig);
  </script>
</body>
</html>
