<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CF Pages åŸŸåç®¡ç†</title>
  <style>
    :root{--orange:#F48120;--orange-dark:#EA700F;--text:#1f2937;--card:#fff;--shadow:0 6px 28px rgba(0,0,0,.08);}
    *{box-sizing:border-box;}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto;color:var(--text);background:linear-gradient(135deg,var(--orange) 0%,#FA6B1D 60%,var(--orange-dark) 100%);}
    .container{max-width:1000px;margin:0 auto;padding:28px;}
    .header{text-align:center;color:#fff;margin-bottom:28px;}
    .header h1{font-size:28px;margin:0 0 6px;text-shadow:0 2px 6px rgba(0,0,0,.25);}
    .header p{margin:0;opacity:.95;}
    .card{background:var(--card);border-radius:14px;padding:20px;box-shadow:var(--shadow);border:1px solid #eaeaea;margin-bottom:16px;}
    .section-title{font-weight:700;color:#374151;margin:0 0 12px;font-size:16px;}
    label{display:block;font-weight:600;color:#374151;margin-bottom:6px;font-size:14px;}
    input,select{width:100%;padding:12px 14px;font-size:14px;border-radius:8px;border:1.5px solid #e2e8f0;background:#fff;}
    input:focus,select:focus{outline:none;border-color:var(--orange);box-shadow:0 0 0 4px rgba(244,129,32,.15);}
    .btn{width:100%;padding:12px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:700;color:white;background:linear-gradient(135deg,var(--orange) 0%,#F59D3B 100%);margin-top:10px;}
    .btn:hover{transform:translateY(-1px);}
    .btn.secondary{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);}
    .btn.success{background:linear-gradient(135deg,#10b981 0%,#059669 100%);}
    .btn.danger{background:linear-gradient(135deg,#f87171 0%,#f43f5e 100%);}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
    .domain-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:8px;background:#f9f9f9;margin-bottom:6px;border:1px solid #eee;}
    .domain-name{font-weight:600;color:#374151;flex:1;}
    .domain-status{font-size:12px;padding:2px 8px;border-radius:4px;margin:0 8px;}
    .status-active{background:#d1fae5;color:#065f46;}
    .status-pending{background:#fef3c7;color:#92400e;}
    .domain-actions button{padding:6px 12px;font-size:12px;border-radius:6px;border:0;cursor:pointer;background:#f87171;color:white;}
    .output{white-space:pre-wrap;background:#111;color:#e5e7eb;padding:12px;border-radius:8px;min-height:100px;font-size:13px;}
    .info{background:#eff6ff;border-left:4px solid #3b82f6;padding:10px;border-radius:6px;font-size:13px;color:#1e40af;margin-bottom:12px;}
    .btn-group{display:flex;gap:8px;}
    .btn-group .btn{margin-top:0;}
    @media(max-width:900px){.grid{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>â˜ï¸ Cloudflare Pages åŸŸåç®¡ç†</h1>
      <p>è‡ªåŠ¨åˆ›å»º DNS è®°å½• + é…ç½®ä¿å­˜</p>
    </div>
    <div class="card">
      <div class="section-title">ğŸ”‘ API é…ç½®</div>
      <div class="info">ğŸ’¾ é…ç½®ä¼šä¿å­˜åœ¨ KV ä¸­ï¼Œä¸‹æ¬¡æ‰“å¼€è‡ªåŠ¨åŠ è½½</div>
      <label>Account ID<input id="accountId" placeholder="ä½ çš„ Account ID"/></label>
      <label style="margin-top:10px;">Pages API Token<input id="pagesToken" type="password" placeholder="ç”¨äºç®¡ç† Pages é¡¹ç›®"/></label>
      <label style="margin-top:10px;">Zone API Token<input id="zoneToken" type="password" placeholder="ç”¨äºåˆ›å»º DNS è®°å½•"/></label>
      <div class="btn-group" style="margin-top:12px;">
        <button class="btn success" id="saveConfigBtn" style="flex:1;">ğŸ’¾ ä¿å­˜é…ç½®</button>
        <button class="btn secondary" id="loadConfigBtn" style="flex:1;">ğŸ“¥ åŠ è½½é…ç½®</button>
      </div>
    </div>
    <div class="grid">
      <div class="card">
        <div class="section-title">Pages é¡¹ç›®</div>
        <div style="display:flex;gap:10px;">
          <select id="projectSelect" style="flex:1;"><option value="">-- å…ˆåŠ è½½é¡¹ç›® --</option></select>
          <button class="btn secondary" id="loadProjectsBtn" style="flex:0 0 auto;width:auto;margin:0;">åŠ è½½</button>
        </div>
        <button class="btn" id="refreshDomainsBtn">åˆ·æ–°åŸŸå</button>
      </div>
      <div class="card">
        <div class="section-title">å·²ç»‘å®šåŸŸå</div>
        <div id="domainList"></div>
        <div style="height:1px;background:#eee;margin:14px 0;"></div>
        <label>æ–°å¢åŸŸå<input id="addDomainInput" placeholder="sub.hyeri.us.kg"/></label>
        <button class="btn" id="addDomainBtn">æ·»åŠ åŸŸå + è‡ªåŠ¨åˆ›å»ºDNS</button>
        <div style="height:1px;background:#eee;margin:14px 0;"></div>
        <label>åˆ é™¤åŸŸå<input id="removeDomainInput" placeholder="sub.hyeri.us.kg"/></label>
        <button class="btn danger" id="removeDomainBtn">åˆ é™¤åŸŸå</button>
      </div>
    </div>
    <div class="card">
      <div class="section-title">ğŸ“¡ æ“ä½œæ—¥å¿—</div>
      <pre id="output" class="output">ç­‰å¾…æ“ä½œ...</pre>
    </div>
  </div>
  <script>
    const accountId=document.getElementById('accountId');
    const pagesToken=document.getElementById('pagesToken');
    const zoneToken=document.getElementById('zoneToken');
    const projectSelect=document.getElementById('projectSelect');
    const loadProjectsBtn=document.getElementById('loadProjectsBtn');
    const domainList=document.getElementById('domainList');
    const addDomainInput=document.getElementById('addDomainInput');
    const addDomainBtn=document.getElementById('addDomainBtn');
    const removeDomainInput=document.getElementById('removeDomainInput');
    const removeDomainBtn=document.getElementById('removeDomainBtn');
    const refreshDomainsBtn=document.getElementById('refreshDomainsBtn');
    const saveConfigBtn=document.getElementById('saveConfigBtn');
    const loadConfigBtn=document.getElementById('loadConfigBtn');
    const output=document.getElementById('output');

    async function apiCall(path,method='GET',body=null){
      output.textContent='â³ è¯·æ±‚ä¸­...';
      try{
        const resp=await fetch(path,{
          method,
          headers:{
            'Content-Type':'application/json',
            'X-Account-Id':accountId.value.trim(),
            'X-Pages-Token':pagesToken.value.trim(),
            'X-Zone-Token':zoneToken.value.trim()
          },
          body:body?JSON.stringify(body):null
        });
        const data=await resp.json().catch(()=>({error:'æ— æ•ˆå“åº”'}));
        output.textContent=JSON.stringify(data,null,2);
        return{ok:resp.ok,data};
      }catch(e){
        output.textContent='âŒ é”™è¯¯: '+e.message;
        return{ok:false,data:null};
      }
    }

    // ä¿å­˜é…ç½®åˆ° KV
    async function saveConfig(){
      const config={
        accountId:accountId.value.trim(),
        pagesToken:pagesToken.value.trim(),
        zoneToken:zoneToken.value.trim()
      };
      if(!config.accountId||!config.pagesToken||!config.zoneToken){
        alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
        return;
      }
      const res=await fetch('/api/config',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(config)
      });
      const data=await res.json();
      if(data.success){
        alert('âœ… é…ç½®ä¿å­˜æˆåŠŸ');
      }else{
        alert('âŒ ä¿å­˜å¤±è´¥');
      }
    }

    // ä» KV åŠ è½½é…ç½®
    async function loadConfig(){
      const res=await fetch('/api/config');
      const data=await res.json();
      if(data.success&&data.config){
        accountId.value=data.config.accountId||'';
        pagesToken.value=data.config.pagesToken||'';
        zoneToken.value=data.config.zoneToken||'';
        output.textContent='âœ… é…ç½®åŠ è½½æˆåŠŸ';
      }else{
        output.textContent='âš ï¸ æœªæ‰¾åˆ°ä¿å­˜çš„é…ç½®';
      }
    }

    async function loadProjects(){
      const acc=accountId.value.trim();
      if(!acc||!pagesToken.value.trim())return alert('è¯·å¡«å†™ Account ID å’Œ Pages Token');
      const res=await apiCall(`/api/accounts/${encodeURIComponent(acc)}/projects`);
      if(res.ok&&res.data.success){
        const projects=res.data.result||[];
        projectSelect.innerHTML=projects.map(p=>`<option value="${p.name}">${p.name}</option>`).join('');
        if(projects.length>0){
          projectSelect.value=projects[0].name;
          await loadDomains();
        }
      }
    }

    async function loadDomains(){
      const acc=accountId.value.trim();
      const proj=projectSelect.value;
      if(!acc||!proj)return;
      const res=await apiCall(`/api/accounts/${encodeURIComponent(acc)}/projects/${encodeURIComponent(proj)}/domains`);
      domainList.innerHTML='';
      if(res.ok&&res.data.success){
        const domains=res.data.result||[];
        if(domains.length===0){
          domainList.innerHTML='<div style="color:#555;padding:8px;">æš‚æ— åŸŸå</div>';
        }else{
          domains.forEach(d=>{
            const statusClass=d.status==='active'?'status-active':'status-pending';
            const statusText=d.status==='active'?'âœ“ æ¿€æ´»':'â³ éªŒè¯ä¸­';
            const el=document.createElement('div');
            el.className='domain-item';
            el.innerHTML=`<span class="domain-name">${d.name}</span><span class="domain-status ${statusClass}">${statusText}</span><div class="domain-actions"><button onclick="confirmAndRemove('${encodeURIComponent(d.name)}')">åˆ é™¤</button></div>`;
            domainList.appendChild(el);
          });
        }
      }
    }

    window.confirmAndRemove=async function(domainEncoded){
      const domain=decodeURIComponent(domainEncoded);
      if(!confirm(`ç¡®å®šåˆ é™¤ ${domain}?`))return;
      const acc=accountId.value.trim();
      const proj=projectSelect.value;
      const res=await apiCall(`/api/accounts/${encodeURIComponent(acc)}/projects/${encodeURIComponent(proj)}/domains/${domain}`,'DELETE');
      if(res.ok&&res.data.success){
        await loadDomains();
        alert('åˆ é™¤æˆåŠŸ');
      }
    };

    addDomainBtn.addEventListener('click',async()=>{
      const acc=accountId.value.trim();
      const proj=projectSelect.value;
      const domain=addDomainInput.value.trim();
      if(!acc||!proj||!domain||!pagesToken.value.trim()||!zoneToken.value.trim()){
        return alert('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ');
      }
      const res=await apiCall(`/api/accounts/${encodeURIComponent(acc)}/projects/${encodeURIComponent(proj)}/domains`,'POST',{name:domain});
      if(res.ok&&res.data.success){
        addDomainInput.value='';
        await loadDomains();
        alert(res.data.dns_created?'âœ… åŸŸåå’ŒDNSéƒ½åˆ›å»ºæˆåŠŸï¼':'âœ… åŸŸååˆ›å»ºæˆåŠŸ');
      }
    });

    removeDomainBtn.addEventListener('click',async()=>{
      const acc=accountId.value.trim();
      const proj=projectSelect.value;
      const domain=removeDomainInput.value.trim();
      if(!acc||!proj||!domain)return alert('è¯·å¡«å†™å®Œæ•´');
      const res=await apiCall(`/api/accounts/${encodeURIComponent(acc)}/projects/${encodeURIComponent(proj)}/domains/${domain}`,'DELETE');
      if(res.ok&&res.data.success){
        removeDomainInput.value='';
        await loadDomains();
        alert('åˆ é™¤æˆåŠŸ');
      }
    });

    refreshDomainsBtn.addEventListener('click',loadDomains);
    loadProjectsBtn.addEventListener('click',loadProjects);
    projectSelect.addEventListener('change',loadDomains);
    saveConfigBtn.addEventListener('click',saveConfig);
    loadConfigBtn.addEventListener('click',loadConfig);

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½é…ç½®
    window.addEventListener('DOMContentLoaded',loadConfig);
  </script>
</body>
</html>
